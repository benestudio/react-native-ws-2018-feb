{"version":3,"sources":["__integration_tests__/UserManager-test.js"],"names":["XDL_TEST_CLIENT_ID","_makeShortId","salt","minLength","hashIds","encode","Date","now","describe","let","userForTest","userForTestPassword","beforeAll","async","process","env","__UNSAFE_EXPO_HOME_DIRECTORY","path","join","uuid","v1","UserManager","_newTestUserManager","username","password","newUser","await","registerAsync","email","givenName","familyName","logoutAsync","afterAll","fs","removeSync","api","ApiV2Client","clientForUser","postAsync","e","console","error","it","default","require","expect","toBeDefined","initialize","ensureLoggedInAsync","noTrackError","message","toEqual","loginAsync","user","getCurrentUserAsync","not","toBeNull","toBe","idToken","toBeFalsy","_getProfileSpy","jest","fn","_getProfileAsync","toHaveBeenCalled","_currentUser","users","Promise","all","toHaveBeenCalledTimes","refreshToken","initialUser","refreshSessionThreshold","_auth0RefreshTokenSpy","_auth0RefreshToken","currentUser","toBeCalled"],"mappings":"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","file":"../../__integration_tests__/UserManager-test.js","sourcesContent":["/**\n * @flow\n */\n\nimport fs from 'fs-extra';\nimport path from 'path';\nimport HashIds from 'hashids';\nimport uuid from 'uuid';\nimport ApiV2Client from '../ApiV2';\nimport { UserManagerInstance } from '../User';\n\nconst XDL_TEST_CLIENT_ID = 'o0YygTgKhOTdoWj10Yl9nY2P0SMTw38Y';\n\nimport type { User } from '../User';\n\nconst _makeShortId = (salt: string, minLength: number = 10): string => {\n  const hashIds = new HashIds(salt, minLength);\n  return hashIds.encode(Date.now());\n};\n\ndescribe('UserManager', () => {\n  let userForTest;\n  let userForTestPassword;\n\n  beforeAll(async () => {\n    process.env.__UNSAFE_EXPO_HOME_DIRECTORY = path.join(\n      '/',\n      'tmp',\n      `.expo-${_makeShortId(uuid.v1())}`\n    );\n\n    const UserManager = _newTestUserManager();\n\n    const username = `xdl-test-${_makeShortId(uuid.v1())}`;\n    const password = uuid.v1();\n\n    // Register a new user that we can use for this test run\n    const newUser = await UserManager.registerAsync({\n      username,\n      password,\n      email: `adam+${username}@getexponent.com`,\n      givenName: 'XDL',\n      familyName: 'Test User',\n    });\n\n    userForTest = newUser;\n    userForTestPassword = password; // save password so we can use it to login\n\n    await UserManager.logoutAsync(); // log us out so we're in a clean state for these tests\n  });\n\n  afterAll(async () => {\n    if (process.env.__UNSAFE_EXPO_HOME_DIRECTORY) {\n      fs.removeSync(process.env.__UNSAFE_EXPO_HOME_DIRECTORY);\n    }\n\n    const api = ApiV2Client.clientForUser(userForTest);\n    try {\n      await api.postAsync('auth/deleteUser');\n    } catch (e) {\n      console.error(e);\n    }\n  });\n\n  it('should make available a global, shared UserManager singleton', () => {\n    const { default: UserManager } = require('../User');\n    expect(UserManager).toBeDefined();\n    expect(UserManager.initialize).toBeDefined();\n  });\n\n  it('should not have a currently logged in user', async () => {\n    const UserManager = _newTestUserManager();\n    try {\n      await UserManager.ensureLoggedInAsync({ noTrackError: true });\n    } catch (e) {\n      expect(e.message).toEqual('Not logged in');\n    }\n  });\n\n  it('should login successfully', async () => {\n    const UserManager = _newTestUserManager();\n    await UserManager.loginAsync('user-pass', {\n      username: userForTest.username,\n      password: userForTestPassword,\n    });\n\n    const user = await UserManager.getCurrentUserAsync();\n    expect(user).not.toBeNull();\n    if (!user) {\n      return;\n    }\n    expect(user.username).toBe(userForTest.username);\n    expect(user.idToken).not.toBeFalsy();\n  });\n\n  it('should use cached user after first run of getCurrentUserAsync() instead of verifying token with Auth0', async () => {\n    const UserManager = _newTestUserManager();\n    await UserManager.loginAsync('user-pass', {\n      username: userForTest.username,\n      password: userForTestPassword,\n    });\n\n    // Spy on getProfileAsync\n    const _getProfileSpy = jest.fn(UserManager._getProfileAsync);\n    // $FlowFixMe\n    UserManager._getProfileAsync = _getProfileSpy;\n\n    await UserManager.getCurrentUserAsync();\n\n    expect(_getProfileSpy).not.toHaveBeenCalled();\n  });\n\n  it('should correctly use lock to prevent getting session twice, simulatenously', async () => {\n    const UserManager = _newTestUserManager();\n    await UserManager.loginAsync('user-pass', {\n      username: userForTest.username,\n      password: userForTestPassword,\n    });\n\n    UserManager._currentUser = null;\n\n    // Spy on getProfileAsync\n    const _getProfileSpy = jest.fn(UserManager._getProfileAsync);\n    // $FlowFixMe\n    UserManager._getProfileAsync = _getProfileSpy;\n\n    const users = ((await Promise.all([\n      UserManager.getCurrentUserAsync(),\n      UserManager.getCurrentUserAsync(),\n    ]): any): Array<User>);\n\n    expect(_getProfileSpy).toHaveBeenCalledTimes(1);\n\n    // This shouldn't have changed, but just double check it\n    expect(users[0].idToken).toEqual(users[1].idToken);\n    expect(users[0].refreshToken).toEqual(users[1].refreshToken);\n  });\n\n  it('should detect expired token when calling getCurrentUserAsync', async () => {\n    const UserManager = _newTestUserManager();\n    // Make sure we have a session\n    const initialUser = await UserManager.loginAsync('user-pass', {\n      username: userForTest.username,\n      password: userForTestPassword,\n    });\n    // set the refresh session threshold to a very high value, simulating an expired token\n    UserManager.refreshSessionThreshold = 63072000;\n\n    // Spy on _auth0RefreshToken\n    const _auth0RefreshTokenSpy = jest.fn(UserManager._auth0RefreshToken);\n    // $FlowFixMe\n    UserManager._auth0RefreshToken = _auth0RefreshTokenSpy;\n\n    const currentUser = ((await UserManager.getCurrentUserAsync(): any): User);\n    expect(_auth0RefreshTokenSpy).toBeCalled();\n    expect(currentUser.idToken).not.toEqual(initialUser.idToken);\n  });\n});\n\nfunction _newTestUserManager() {\n  const UserManager = new UserManagerInstance();\n  UserManager.initialize(XDL_TEST_CLIENT_ID); // XDL Test Client\n  return UserManager;\n}\n"],"sourceRoot":"/xdl/src"}